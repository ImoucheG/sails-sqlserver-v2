//  ██████╗ ███████╗██╗     ███████╗ █████╗ ███████╗███████╗
//  ██╔══██╗██╔════╝██║     ██╔════╝██╔══██╗██╔════╝██╔════╝
//  ██████╔╝█████╗  ██║     █████╗  ███████║███████╗█████╗
//  ██╔══██╗██╔══╝  ██║     ██╔══╝  ██╔══██║╚════██║██╔══╝
//  ██║  ██║███████╗███████╗███████╗██║  ██║███████║███████╗
//  ╚═╝  ╚═╝╚══════╝╚══════╝╚══════╝╚═╝  ╚═╝╚══════╝╚══════╝
//
//   ██████╗ ██████╗ ███╗   ██╗███╗   ██╗███████╗ ██████╗████████╗██╗ ██████╗ ███╗   ██╗
//  ██╔════╝██╔═══██╗████╗  ██║████╗  ██║██╔════╝██╔════╝╚══██╔══╝██║██╔═══██╗████╗  ██║
//  ██║     ██║   ██║██╔██╗ ██║██╔██╗ ██║█████╗  ██║        ██║   ██║██║   ██║██╔██╗ ██║
//  ██║     ██║   ██║██║╚██╗██║██║╚██╗██║██╔══╝  ██║        ██║   ██║██║   ██║██║╚██╗██║
//  ╚██████╗╚██████╔╝██║ ╚████║██║ ╚████║███████╗╚██████╗   ██║   ██║╚██████╔╝██║ ╚████║
//   ╚═════╝ ╚═════╝ ╚═╝  ╚═══╝╚═╝  ╚═══╝╚══════╝ ╚═════╝   ╚═╝   ╚═╝ ╚═════╝ ╚═╝  ╚═══╝
//
// Release an open database connection.

const SQLSERVER = require('machinepack-sqlserver-adapter');

module.exports = async function releaseConnection(connection, manager, leased) {
  try {
    // If this connection was leased outside of the Adapter, don't release it.
    if (leased) {
      return Promise.resolve();
    }
    await SQLSERVER.releaseConnection({
      connection: connection,
      manager: manager,
    }).catch(err => {
      if (err.exit === 'error') {
        return Promise.reject(new Error('There was an error releasing the connection back into the pool.' + err.stack));
      }
      if (err.exit === 'badConnection') {
        return Promise.reject(new Error('Bad connection when trying to release an active connection.'));
      }
    });
    return Promise.resolve();
  } catch (err) {
    return Promise.reject(new Error(err));
  }
};
